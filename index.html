<!DOCTYPE html>
<html>

<head>
    <title>dot.most.box</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link rel="stylesheet" href="./index.css">
    <style>
        .notification-test {
            max-width: 480px;
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .notification-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
    </style>
</head>

<body>
    <div id="app">
        <h2>â˜­ ä¸ºäººæ°‘æœåŠ¡</h2>
        <h1 id="hello">
            IPFS + Filecoin + Fastify + dot.most.box + Smart Contracts = Fully DApp
        </h1>

        <div class="wallet">
            <input id="inputUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å"></input>
            <input id="inputPassword" placeholder="è¯·è¾“å…¥å¯†ç "></input>
            <button id="btnLogin">ç™»å½•</button>
            <div>Or</div>
            <button id="btnConnect">è¿æ¥é’±åŒ…</button>
        </div>

        <span id="addressDisplay"></span>

        <div class="wallet-name">
            <input type="text" id="inputName" placeholder="è¾“å…¥åç§°" />
            <button id="btnSave" disabled>ä¿å­˜</button>
        </div>

        <!-- é€šçŸ¥æµ‹è¯•åŒºåŸŸ -->
        <div class="notification-test" id="notificationTest">
            <h3>é€šçŸ¥æµ‹è¯•</h3>

            <input type="text" id="receiverAddress" placeholder="æ¥æ”¶è€…åœ°å€" />
            <input type="text" id="notificationMessage" placeholder="é€šçŸ¥å†…å®¹" />
            <button id="btnSendNotification">å‘é€é€šçŸ¥</button>


            <h4>æˆ‘çš„é€šçŸ¥</h4>
            <div class="notification-list" id="notificationList"></div>

            <button id="btnClearNotifications" style=" background-color: #f44336;">æ¸…é™¤æ‰€æœ‰é€šçŸ¥</button>

        </div>
    </div>

    <!-- https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.5/ethers.umd.min.js -->
    <script src="./js/ethers.umd.min.js"></script>
    <!-- https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.2/nacl-fast.min.js" -->
    <script src="./js/nacl-fast.min.js"></script>
    <script src="./dist/index.js"></script>
    <script>
        const { DotClient, mostWallet } = Dot
        const dotClient = new DotClient([location.origin])
        let userAddress = ''

        const init = (signer) => {
            // åˆ›å»ºç”¨æˆ·å®ä¾‹
            const dot = dotClient.dot(userAddress)

            // è®¾ç½®ç­¾åå™¨
            dot.setSigner(signer)

            // ç›‘å¬ç”¨æˆ·æ•°æ®å˜åŒ– - ç°åœ¨è‡ªåŠ¨å¤„ç†è§£å¯†
            let t = 0
            dot.on('profile', (profile, timestamp) => {
                if (timestamp > t) {
                    t = timestamp
                    if (profile && profile.name) {
                        inputName.value = profile.name
                    }
                }
            }, { decrypt: true }) // ä½¿ç”¨ decrypt é€‰é¡¹è‡ªåŠ¨è§£å¯†

            // å¯ç”¨ä¿å­˜æŒ‰é’®
            btnSave.disabled = false
            document.querySelector('.wallet').style.display = 'none'

            // æ˜¾ç¤ºé€šçŸ¥æµ‹è¯•åŒºåŸŸ
            document.getElementById('notificationTest').style.display = 'flex'

            // ç›‘å¬é€šçŸ¥
            dot.on('notify', (notifications) => {
                console.log('ğŸŒŠ', notifications)
                displayNotifications(notifications)
            })
        }

        btnLogin.addEventListener('click', async () => {
            // åˆå§‹åŒ–é’±åŒ…
            const wallet = mostWallet(inputUsername.value, inputPassword.value, 'I know loss mnemonic will lose my wallet.')
            userAddress = wallet.address
            addressDisplay.textContent = `å½“å‰åœ°å€: ${userAddress}`

            const signer = ethers.HDNodeWallet.fromPhrase(wallet.mnemonic)

            // è®¾ç½®åŠ å¯†æ‰€éœ€çš„å¯†é’¥
            const dot = dotClient.dot(userAddress)
            dot.setPubKey(wallet.public_key)
            dot.setPrivKey(wallet.private_key)

            init(signer)
        })

        btnConnect.addEventListener('click', async () => {
            // æ£€æŸ¥æ˜¯å¦å®‰è£…äº†é’±åŒ…æ’ä»¶
            if (typeof window.ethereum === 'undefined') {
                alert('è¯·å…ˆå®‰è£… OKX é’±åŒ…æ’ä»¶')
                return
            }

            try {
                // è¯·æ±‚ç”¨æˆ·è¿æ¥ MetaMask
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' })
                // åˆ›å»º ethers provider å’Œ signer
                const provider = new ethers.BrowserProvider(window.ethereum)
                const signer = await provider.getSigner()
                const address = await signer.getAddress()
                const sig = await signer.signMessage(address)
                const wallet = Dot.mostWallet(address, sig)

                userAddress = address
                addressDisplay.textContent = `å½“å‰åœ°å€: ${address}`

                // è®¾ç½®åŠ å¯†æ‰€éœ€çš„å¯†é’¥
                const dot = dotClient.dot(userAddress)
                dot.setPubKey(wallet.public_key)
                dot.setPrivKey(wallet.private_key)

                init(signer)
            } catch (error) {
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error)
                alert('è¿æ¥é’±åŒ…å¤±è´¥')
            }
        })

        btnSave.addEventListener('click', async () => {
            const dot = dotClient.dot(userAddress)
            // å­˜å‚¨ç”¨æˆ·æ•°æ® - ç°åœ¨ä¼ é€’å¯¹è±¡å¹¶ä½¿ç”¨åŠ å¯†æ ‡å¿—
            dot.put('profile', {
                name: inputName.value,
                bio: 'Web3 Developer',
            }, true) // ç¬¬ä¸‰ä¸ªå‚æ•° true è¡¨ç¤ºåŠ å¯†å­˜å‚¨
        })

        // å‘é€é€šçŸ¥
        document.getElementById('btnSendNotification').addEventListener('click', async () => {
            const receiverAddress = document.getElementById('receiverAddress').value
            const message = document.getElementById('notificationMessage').value

            if (!receiverAddress || !message) {
                alert('è¯·è¾“å…¥æ¥æ”¶è€…åœ°å€å’Œé€šçŸ¥å†…å®¹')
                return
            }

            try {
                const dot = dotClient.dot(userAddress)
                // å‘é€é€šçŸ¥
                const receiverDot = dotClient.dot(receiverAddress)
                receiverDot.on('notify', (notifications) => {

                    receiverDot.off('notify')
                    let list = []
                    if (notifications[userAddress]) {
                        list = notifications[userAddress].value
                    }
                    list.push(message)
                    dot.notify(receiverAddress, list)
                    document.getElementById('notificationMessage').value = ''
                    console.log('å‘é€æˆåŠŸ')
                })

            } catch (error) {
                console.error('å‘é€å¤±è´¥:', error)
            }
        })

        // æ˜¾ç¤ºé€šçŸ¥
        const displayNotifications = (notifications) => {
            const notificationList = document.getElementById('notificationList')

            if (!notifications || typeof notifications !== 'object' || Object.keys(notifications).length === 0) {
                notificationList.innerHTML = '<div>æš‚æ— é€šçŸ¥</div>'
                return
            }

            // æ¸…ç©ºç°æœ‰é€šçŸ¥
            notificationList.innerHTML = ''
            const list = Object.keys(notifications).map(key => { return { from: key, ...notifications[key] } })

            // æ˜¾ç¤ºé€šçŸ¥
            list.sort((a, b) => b.timestamp - a.timestamp).forEach(notification => {
                const notificationItem = document.createElement('div')
                notificationItem.className = 'notification-item'

                const date = new Date(notification.timestamp)
                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`

                notificationItem.innerHTML = `
                    <div><strong>å‘é€è€…:</strong> ${notification.from}</div>
                    <div><strong>å†…å®¹:</strong> ${notification.value}</div>
                    <div><strong>æ—¶é—´:</strong> ${formattedDate}</div>
                `

                notificationList.appendChild(notificationItem)
            })
        }

        document.getElementById('btnClearNotifications').addEventListener('click', async () => {
            try {
                const dot = dotClient.dot(userAddress)
                // æ¸…é™¤é€šçŸ¥ - é€šè¿‡å°†é€šçŸ¥é”®è®¾ç½®ä¸ºç©ºå¯¹è±¡æ¥å®ç°
                await dot.put('notify', {})
                // æ›´æ–°æ˜¾ç¤º
                displayNotifications({})
            } catch (error) {
                console.error('æ¸…é™¤é€šçŸ¥å¤±è´¥:', error)
                alert('æ¸…é™¤å¤±è´¥: ' + error.message)
            }
        })

    </script>
</body>

</html>